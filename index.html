<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Employee System</title>
    <meta name="description" content="Contact us for any inquiries about our automated employee system. Email us at contactmashab@gmail.com.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF for Resume Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        #app-container.hidden {
            display: none;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Custom scrollbar for resume modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- This container holds the main app. It will be hidden during redirects. -->
    <div id="app-container">
        <!-- Navbar -->
        <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-indigo-600">AutoSystem</a>
                <div class="hidden md:flex space-x-8 items-center" id="nav-links">
                    <!-- Logged out links -->
                    <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="signin">Sign In</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="signup">Sign Up</a>
                    <!-- Logged in links -->
                    <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="main">Main</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="dashboard">Dashboard</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="profile">Profile</a>
                    <div class="relative">
                        <button id="notification-bell" class="hidden text-gray-600 hover:text-indigo-600 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <span id="notification-dot" class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg z-20">
                           <div class="py-2 px-4 font-bold border-b">Notifications</div>
                           <div id="notification-list" class="py-1 max-h-64 overflow-y-auto">
                               <!-- Notifications will be populated here -->
                           </div>
                        </div>
                    </div>
                    <button id="logout-btn" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Logout</button>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden px-6 pt-2 pb-4 space-y-2 bg-white">
                <!-- Logged out links -->
                <a href="#" class="block nav-link text-gray-600 hover:text-indigo-600" data-page="signin">Sign In</a>
                <a href="#" class="block nav-link text-gray-600 hover:text-indigo-600" data-page="signup">Sign Up</a>
                <!-- Logged in links -->
                <a href="#" class="block nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="main">Main</a>
                <a href="#" class="block nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="dashboard">Dashboard</a>
                <a href="#" class="block nav-link text-gray-600 hover:text-indigo-600 hidden" data-page="profile">Profile</a>
                <button id="mobile-logout-btn" class="w-full text-left block bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 hidden">Logout</button>
            </div>
        </nav>

        <main class="container mx-auto px-6 py-8">

            <!-- Sign In Page -->
            <div id="signin-page" class="page active">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center text-indigo-600">Sign In</h2>
                    <form id="signin-form">
                        <div class="mb-4">
                            <label for="signin-email" class="block text-gray-700 mb-2">Email</label>
                            <input type="email" id="signin-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="signin-password" class="block text-gray-700 mb-2">Password</label>
                            <input type="password" id="signin-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Sign In</button>
                    </form>
                    <div class="text-center mt-4">
                        <a href="#" id="forgot-password-link" class="text-sm text-indigo-600 hover:underline">Forgot Password?</a>
                    </div>
                    <p class="text-center mt-4">Don't have an account? <a href="#" class="text-indigo-600 hover:underline nav-link" data-page="signup">Sign Up</a></p>
                    <div id="signin-error" class="text-red-500 mt-4 text-center"></div>
                </div>
            </div>

            <!-- Sign Up Page -->
            <div id="signup-page" class="page">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center text-indigo-600">Create Your ID</h2>
                    <form id="signup-form">
                        <div class="mb-4">
                            <label for="signup-name" class="block text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="signup-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block text-gray-700 mb-2">Email</label>
                            <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block text-gray-700 mb-2">Password</label>
                            <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Sign Up</button>
                    </form>
                     <p class="text-center mt-4">Already have an account? <a href="#" class="text-indigo-600 hover:underline nav-link" data-page="signin">Sign In</a></p>
                    <div id="signup-error" class="text-red-500 mt-4 text-center"></div>
                </div>
            </div>

            <!-- Main Page -->
            <div id="main-page" class="page">
                <!-- Attendance Section -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-4">Daily Attendance</h2>
                    <form id="attendance-form">
                        <div class="mb-4">
                            <label for="attendance-link" class="block text-gray-700 mb-2">Add Work Link for Today</label>
                            <input type="url" id="attendance-link" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://example.com/work-proof" required>
                        </div>
                        <button type="submit" id="mark-attendance-btn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-300">Mark Attendance</button>
                    </form>
                    <div id="attendance-status" class="mt-4 text-center font-semibold"></div>
                </div>

                <h1 class="text-4xl font-bold mb-4">Your Short Links</h1>
                <p class="text-lg text-gray-600 mb-8">Share these links to track clicks and earn rewards.</p>
                <div id="short-links-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Short links will be dynamically inserted here -->
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page">
                <h1 class="text-4xl font-bold mb-8">Dashboard</h1>
                <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-4">Your Clicks This Month</h2>
                    <p class="text-5xl font-bold text-indigo-600" id="total-clicks">0</p>
                </div>

                <h2 class="text-3xl font-bold mb-6">Eligibility & Rewards</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <!-- Starter Tier -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                        <h3 class="text-xl font-bold mb-2 text-green-600">Starter Tier</h3>
                        <p class="text-gray-600 mb-4">5 clicks</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                            <div id="starter-progress" class="bg-green-500 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                        <button id="claim-starter" class="claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed" data-tier="starter" data-clicks="5" disabled>Claim Reward</button>
                    </div>
                    <!-- Bronze Tier -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-yellow-600">
                        <h3 class="text-xl font-bold mb-2 text-yellow-700">Bronze Tier</h3>
                        <p class="text-gray-600 mb-4">7,500 clicks</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                            <div id="bronze-progress" class="bg-yellow-500 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                        <button id="claim-bronze" class="claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed" data-tier="bronze" data-clicks="7500" disabled>Claim Reward</button>
                    </div>
                    <!-- Silver Tier -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-gray-400">
                        <h3 class="text-xl font-bold mb-2 text-gray-500">Silver Tier</h3>
                        <p class="text-gray-600 mb-4">15,000 clicks</p>
                         <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                            <div id="silver-progress" class="bg-gray-400 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                        <button id="claim-silver" class="claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed" data-tier="silver" data-clicks="15000" disabled>Claim Reward</button>
                    </div>
                    <!-- Gold Tier -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-yellow-400">
                        <h3 class="text-xl font-bold mb-2 text-yellow-500">Gold Tier</h3>
                        <p class="text-gray-600 mb-4">50,000 clicks</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                            <div id="gold-progress" class="bg-yellow-400 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                        <p class="text-sm text-green-600 font-semibold mt-2">Eligible to work with us!</p>
                        <button id="claim-gold" class="claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed mt-4" data-tier="gold" data-clicks="50000" disabled>Claim Reward</button>
                    </div>
                    <!-- Diamond Tier -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-300">
                        <h3 class="text-xl font-bold mb-2 text-blue-400">Diamond Tier</h3>
                        <p class="text-gray-600 mb-4">100,000 clicks</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                            <div id="diamond-progress" class="bg-blue-300 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                        <button id="claim-diamond" class="claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed" data-tier="diamond" data-clicks="100000" disabled>Claim Reward</button>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page">
                <h1 class="text-4xl font-bold mb-8">Your Profile</h1>
                <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <form id="profile-form">
                        <div class="mb-4">
                            <label for="profile-name" class="block text-gray-700 mb-2">Name</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="profile-email" class="block text-gray-700 mb-2">Email</label>
                            <input type="email" id="profile-email" class="w-full px-4 py-2 border rounded-lg bg-gray-200 cursor-not-allowed" readonly>
                        </div>
                        <div class="mb-6">
                            <label for="profile-password" class="block text-gray-700 mb-2">New Password (optional)</label>
                            <input type="password" id="profile-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Leave blank to keep current password">
                        </div>
                        <!-- Resume Section -->
                        <div class="mb-6 border-t pt-6 mt-6">
                             <h3 class="text-xl font-bold mb-4">Your Resume</h3>
                             <p id="resume-status" class="text-gray-600 mb-2">You have not created a resume yet.</p>
                             <button type="button" id="add-resume-btn" class="w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600">Add / Edit Resume</button>
                        </div>
                        <!-- Phone Verification Section -->
                        <div id="phone-verification-section" class="border-t pt-6 mt-6">
                            <h3 class="text-xl font-bold mb-4">Phone Verification</h3>
                            <div id="phone-verified-status" class="hidden p-3 rounded-lg bg-green-100 text-green-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                                Your phone number is verified!
                            </div>
                            <div id="phone-input-group">
                                <label for="profile-phone" class="block text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="+1234567890">
                                <button type="button" id="save-phone-btn" class="mt-2 w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">Save Phone Number</button>
                            </div>
                            <div id="otp-input-group" class="hidden mt-4">
                                <p class="text-sm text-gray-600 mb-2">An OTP has been sent by the admin. Please enter it below.</p>
                                <label for="profile-otp" class="block text-gray-700 mb-2">4-Digit OTP</label>
                                <input type="text" id="profile-otp" maxlength="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="1234">
                                <button type="button" id="verify-otp-btn" class="mt-2 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Verify OTP</button>
                            </div>
                            <div id="phone-verification-message" class="mt-4 text-center"></div>
                        </div>
                        <button type="submit" class="mt-8 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Update Profile</button>
                    </form>
                     <div id="profile-message" class="text-green-500 mt-4 text-center"></div>
                </div>
            </div>

            <!-- Privacy Policy Page -->
            <div id="privacy-policy-page" class="page">
                 <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h1 class="text-4xl font-bold mb-6">Privacy Policy</h1>
                    <div class="space-y-4 text-gray-700">
                        <p>Your privacy is important to us. It is AutoSystem's policy to respect your privacy regarding any information we may collect from you across our website.</p>
                        <p>We only ask for personal information when we truly need it to provide a service to you. We collect it by fair and lawful means, with your knowledge and consent. We also let you know why we’re collecting it and how it will be used.</p>
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions Page -->
            <div id="terms-condition-page" class="page">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h1 class="text-4xl font-bold mb-6">Terms and Conditions</h1>
                    <div class="space-y-4 text-gray-700">
                        <p>With AutoSystem, you can earn money with us and build a brighter future. Our platform is designed for those who want a flexible, part-time opportunity to generate income.</p>
                    </div>
                </div>
            </div>

            <!-- Contact Us Page -->
            <div id="contact-us-page" class="page">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg text-center">
                    <h1 class="text-4xl font-bold mb-6">Contact Us</h1>
                    <p class="text-lg text-gray-600 mb-4">Have questions? Reach out to us via email.</p>
                    <a href="mailto:contactmashab@gmail.com" class="text-2xl font-semibold text-indigo-600 hover:underline">contactmashab@gmail.com</a>
                </div>
            </div>

            <!-- About Us Page -->
            <div id="about-us-page" class="page">
                 <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h1 class="text-4xl font-bold mb-6">About Us</h1>
                    <div class="space-y-4 text-gray-700">
                        <p>AutoSystem is an innovative platform designed to empower individuals by providing a unique opportunity to earn rewards and build a career path through a simple, automated system.</p>
                    </div>
                </div>
            </div>

            <!-- Admin Login Page -->
            <div id="admin-login-page" class="page">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Admin Login</h2>
                    <form id="admin-login-form">
                        <div class="mb-4">
                            <label for="admin-email" class="block text-gray-700 mb-2">Admin Email</label>
                            <input type="email" id="admin-email" value="admin@system.com" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="admin-password" class="block text-gray-700 mb-2">Admin Password</label>
                            <input type="password" id="admin-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-900 transition duration-300">Login as Admin</button>
                    </form>
                    <div id="admin-login-error" class="text-red-500 mt-4 text-center"></div>
                </div>
            </div>
            
            <!-- Admin Dashboard Page -->
            <div id="admin-dashboard-page" class="page">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-4xl font-bold">Admin Dashboard</h1>
                    <button id="admin-logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Admin Logout</button>
                </div>
                
                <!-- Admin Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <button data-target="admin-view-users" class="admin-card-btn bg-white p-6 rounded-lg shadow-lg text-left hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-bold text-indigo-600">User Details</h3>
                        <p class="text-gray-600 mt-2">View, message, and manage users.</p>
                    </button>
                    <button data-target="admin-view-attendance" class="admin-card-btn bg-white p-6 rounded-lg shadow-lg text-left hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-bold text-green-600">User Attendance</h3>
                        <p class="text-gray-600 mt-2">See who is present today.</p>
                    </button>
                    <button data-target="admin-view-cvs" class="admin-card-btn bg-white p-6 rounded-lg shadow-lg text-left hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-bold text-yellow-600">User Resumes</h3>
                        <p class="text-gray-600 mt-2">Review submitted resumes.</p>
                    </button>
                     <button data-target="admin-view-links" class="admin-card-btn bg-white p-6 rounded-lg shadow-lg text-left hover:shadow-xl transition-shadow">
                        <h3 class="text-xl font-bold text-blue-600">Manage Links</h3>
                        <p class="text-gray-600 mt-2">Add or remove global links.</p>
                    </button>
                     <button data-target="admin-view-notifications" class="admin-card-btn bg-white p-6 rounded-lg shadow-lg text-left hover:shadow-xl transition-shadow col-span-1 md:col-span-2 lg:col-span-1">
                        <h3 class="text-xl font-bold text-purple-600">Send Notification</h3>
                        <p class="text-gray-600 mt-2">Broadcast a message to all users.</p>
                    </button>
                </div>

                <!-- Admin Views -->
                <div id="admin-views-container">
                    <!-- User Details View -->
                    <div id="admin-view-users" class="admin-view">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">All Users</h2>
                            <input type="text" id="admin-user-search" class="w-full mb-4 px-4 py-2 border rounded-lg" placeholder="Search by name or email...">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead><tr class="bg-gray-100"><th class="p-4">User</th><th class="p-4">Phone</th><th class="p-4">Clicks</th><th class="p-4">Actions</th></tr></thead>
                                    <tbody id="admin-all-users-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Attendance View -->
                    <div id="admin-view-attendance" class="admin-view hidden">
                         <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">User Attendance (<span id="today-date"></span>)</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead><tr class="bg-gray-100"><th class="p-4">User</th><th class="p-4">Status</th><th class="p-4">Submitted Link</th></tr></thead>
                                    <tbody id="admin-attendance-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- CVs View -->
                    <div id="admin-view-cvs" class="admin-view hidden">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Submitted Resumes</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead><tr class="bg-gray-100"><th class="p-4">User</th><th class="p-4">Email</th><th class="p-4">Actions</th></tr></thead>
                                    <tbody id="admin-cv-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <!-- Links View -->
                    <div id="admin-view-links" class="admin-view hidden">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Add New Global Link</h2>
                            <form id="add-link-form">
                                <input type="url" id="new-link-url" class="w-full px-4 py-2 border rounded-lg" placeholder="https://example.com" required>
                                <button type="submit" class="mt-2 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Add Link for All Users</button>
                            </form>
                            <div id="add-link-status" class="mt-2 text-center"></div>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg mt-8">
                            <h2 class="text-2xl font-bold mb-4">Manage Global Links</h2>
                            <div id="global-links-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <!-- Notifications View -->
                    <div id="admin-view-notifications" class="admin-view hidden">
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Send Notification to All Users</h2>
                            <form id="notification-form">
                                <div class="mb-4">
                                    <label for="notification-message" class="block text-gray-700 mb-2">Message</label>
                                    <textarea id="notification-message" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type your announcement here..." required></textarea>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Send Notification</button>
                            </form>
                            <div id="notification-send-status" class="text-green-500 mt-4 text-center font-semibold"></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-white mt-12">
            <div class="container mx-auto px-6 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-gray-600">&copy; 2024 AutoSystem. All rights reserved.</p>
                    <div class="flex space-x-6 mt-4 md:mt-0">
                        <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="privacy-policy">Privacy Policy</a>
                        <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="terms-condition">Terms & Conditions</a>
                        <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="contact-us">Contact Us</a>
                        <a href="#" class="nav-link text-gray-600 hover:text-indigo-600" data-page="about-us">About Us</a>
                        <a href="#" id="admin-link" class="text-gray-600 hover:text-indigo-600">Admin</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Modals Container -->
    <div id="modals-container"></div>
    
    <!-- This div is for showing redirect messages -->
    <div id="redirect-container"></div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut,
            updateProfile,
            updatePassword,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            Timestamp,
            onSnapshot,
            orderBy,
            limit,
            deleteDoc,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
       
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA00mo8NGdqI4-L7Ode-dy0vTda3vExORM",
            authDomain: "automation-system-e0e57.firebaseapp.com",
            projectId: "automation-system-e0e57",
            storageBucket: "automation-system-e0e57.appspot.com",
            messagingSenderId: "679067303232",
            appId: "1:679067303232:web:6259337191075947dc0ea5",
            measurementId: "G-VVDBQHQYHG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { jsPDF } = window.jspdf;

        // --- Generic Modal ---
        function showCustomModal(title, content, showClose = true) {
            const modalsContainer = document.getElementById('modals-container');
            const closeButton = showClose ? `<button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>` : '';
            const modalHTML = `
                <div id="generic-modal" class="modal-backdrop">
                    <div class="modal-content bg-white rounded-lg shadow-lg w-11/12 md:w-1/3">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold">${title}</h2>
                            ${closeButton}
                        </div>
                        <div class="p-6">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            modalsContainer.innerHTML = modalHTML;

            if (showClose) {
                document.getElementById('close-modal-btn').addEventListener('click', () => {
                    modalsContainer.innerHTML = '';
                });
            }
        }

        // --- Link Shortening & Generation ---
        function generateShortCode(originalUrl, userId, linkId) {
            const hash = (s) => {
                let h = 0;
                for(let i = 0; i < s.length; i++) {
                    h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;
                }
                return Math.abs(h).toString(36).substring(0, 6);
            };
            return hash(originalUrl + userId + linkId);
        }
        
        function getShortUrl(shortCode) {
            // Use the current page's origin and pathname for robust redirection
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}#/redirect/${shortCode}`;
        }

        // --- Redirect Handler ---
        const appContainer = document.getElementById('app-container');
        const redirectContainer = document.getElementById('redirect-container');

        async function handleRedirect() {
            if (window.location.hash.startsWith('#/redirect/')) {
                appContainer.classList.add('hidden');
                const shortCode = window.location.hash.substring('#/redirect/'.length);

                if (shortCode) {
                    redirectContainer.innerHTML = `<div class="w-screen h-screen flex justify-center items-center bg-gray-100"><div class="text-center"><h1 class="text-2xl font-bold text-indigo-600">Redirecting...</h1><p class="text-gray-600">Please wait.</p></div></div>`;
                    
                    const shortLinkRef = doc(db, "shortlinks", shortCode);
                    const shortLinkDoc = await getDoc(shortLinkRef);

                    if (shortLinkDoc.exists()) {
                        const { original, ownerId, linkId } = shortLinkDoc.data();
                        
                        try {
                            const userDocRef = doc(db, "users", ownerId);
                            const linkDocRef = doc(db, `users/${ownerId}/links`, linkId);

                            await runTransaction(db, async (transaction) => {
                                const userDoc = await transaction.get(userDocRef);
                                const linkDoc = await transaction.get(linkDocRef);

                                if (!userDoc.exists() || !linkDoc.exists()) {
                                    throw "Document does not exist!";
                                }

                                const newTotalClicks = (userDoc.data().clicks || 0) + 1;
                                const newLinkClicks = (linkDoc.data().clicks || 0) + 1;

                                transaction.update(userDocRef, { clicks: newTotalClicks });
                                transaction.update(linkDocRef, { clicks: newLinkClicks });
                            });
                            
                            window.location.replace(original);

                        } catch (e) {
                            console.error("Transaction failed: ", e);
                            redirectContainer.innerHTML = `<div class="w-screen h-screen flex justify-center items-center bg-gray-100"><div class="text-center"><h1 class="text-2xl font-bold text-red-600">Redirect Failed</h1><p class="text-gray-600">Could not process link click.</p></div></div>`;
                        }
                    } else {
                        redirectContainer.innerHTML = `<div class="w-screen h-screen flex justify-center items-center bg-gray-100"><div class="text-center"><h1 class="text-2xl font-bold text-red-600">Link Not Found</h1><p class="text-gray-600">The link you followed is invalid or has expired.</p></div></div>`;
                    }
                }
            } else {
                appContainer.classList.remove('hidden');
                redirectContainer.innerHTML = '';
            }
        }
        
        window.addEventListener('hashchange', handleRedirect);
        window.addEventListener('load', handleRedirect);


        // --- Page Navigation ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');

        function showPage(pageId, hideAll = false) {
            if (hideAll) {
                 pages.forEach(page => page.classList.remove('active'));
            }
            pages.forEach(page => {
                page.classList.toggle('active', page.id === `${pageId}-page`);
            });
            document.getElementById('mobile-menu').classList.add('hidden');
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                showPage(pageId);
            });
        });

        // --- Mobile Menu ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // --- Authentication State ---
        const loggedInElements = document.querySelectorAll('[data-page="main"], [data-page="dashboard"], [data-page="profile"], #logout-btn, #mobile-logout-btn, #notification-bell');
        const loggedOutLinks = document.querySelectorAll('[data-page="signin"], [data-page="signup"]');
        let unsubscribeNotifications = null;
        let unsubscribeUserData = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                if (!window.location.hash.startsWith('#/redirect/')) {
                    loggedInElements.forEach(link => link.classList.remove('hidden'));
                    loggedOutLinks.forEach(link => link.classList.add('hidden'));
                    showPage('main');
                    loadUserData(user);
                    if (unsubscribeNotifications) unsubscribeNotifications();
                    unsubscribeNotifications = listenForNotifications(user.uid);
                }
            } else {
                if (!window.location.hash.startsWith('#/redirect/')) {
                    loggedInElements.forEach(link => link.classList.add('hidden'));
                    loggedOutLinks.forEach(link => link.classList.remove('hidden'));
                    showPage('signin');
                    if (unsubscribeNotifications) unsubscribeNotifications();
                    if (unsubscribeUserData) unsubscribeUserData();
                }
            }
        });

        // --- Sign Up ---
        const signupForm = document.getElementById('signup-form');
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const signupError = document.getElementById('signup-error');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, { displayName: name });

                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, {
                    name: name,
                    email: email,
                    clicks: 0,
                    phone: '',
                    phoneVerified: false,
                    phoneOtp: '',
                    claimedRewards: { starter: false, bronze: false, silver: false, gold: false, diamond: false },
                    seenNotifications: []
                });
                
                // Add existing global links to the new user
                const globalLinksQuery = query(collection(db, "global_links"));
                const globalLinksSnapshot = await getDocs(globalLinksQuery);
                
                for(const linkDoc of globalLinksSnapshot.docs) {
                    const linkData = linkDoc.data();
                    const linkId = linkDoc.id;
                    const shortCode = generateShortCode(linkData.original, user.uid, linkId);
                    const shortUrl = getShortUrl(shortCode);
                    
                    const userLinkDocRef = doc(db, `users/${user.uid}/links`, linkId);
                    await setDoc(userLinkDocRef, { original: linkData.original, short: shortUrl, clicks: 0, global: true });
                    
                    const shortLinkDocRef = doc(db, "shortlinks", shortCode);
                    await setDoc(shortLinkDocRef, { original: linkData.original, ownerId: user.uid, linkId: linkId });
                }
                
                signupForm.reset();
                signupError.textContent = '';

            } catch (error) {
                signupError.textContent = error.message;
            }
        });

        // --- Sign In & Forgot Password ---
        const signinForm = document.getElementById('signin-form');
        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const signinError = document.getElementById('signin-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                signinForm.reset();
                signinError.textContent = '';
            } catch (error) {
                signinError.textContent = "Invalid email or password.";
            }
        });
        
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        showCustomModal("Success", "Password reset email sent! Please check your inbox.");
                    })
                    .catch((error) => {
                        showCustomModal("Error", "Error sending password reset email: " + error.message);
                    });
            }
        });

        // --- Logout ---
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); window.location.hash = ''; });
        document.getElementById('mobile-logout-btn').addEventListener('click', () => { signOut(auth); window.location.hash = ''; });


        // --- Load User Data ---
        function loadUserData(user) {
            if (!user) return;
            if (unsubscribeUserData) unsubscribeUserData(); // Unsubscribe from previous listener

            const userDocRef = doc(db, "users", user.uid);
            
            // Listen for real-time updates to user data
            unsubscribeUserData = onSnapshot(userDocRef, async (userDoc) => {
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Update UI components that depend on user data
                    await displayShortLinks(user.uid);
                    updateDashboard(userData.clicks, userData.claimedRewards || {});
                    updatePhoneVerificationUI(userData);
                    checkUserAttendance(user.uid);

                    document.getElementById('profile-name').value = user.displayName || '';
                    document.getElementById('profile-email').value = user.email || '';
                    
                    const resumeDocRef = doc(db, `users/${user.uid}/resume`, 'data');
                    const resumeDoc = await getDoc(resumeDocRef);
                    document.getElementById('resume-status').textContent = resumeDoc.exists() 
                        ? 'You have a saved resume on file.'
                        : 'You have not created a resume yet.';
                }
            });
        }

        // --- Display Short Links (Main Page) ---
        async function displayShortLinks(userId) {
            const linksContainer = document.getElementById('short-links-container');
            const linksQuery = query(collection(db, `users/${userId}/links`));
            
            // Use onSnapshot for real-time link updates
            onSnapshot(linksQuery, (linksSnapshot) => {
                linksContainer.innerHTML = ''; 
                if (linksSnapshot.empty) {
                    linksContainer.innerHTML = '<p class="text-gray-600 col-span-full">No links have been assigned to you yet.</p>';
                    return;
                }
                
                linksSnapshot.forEach(doc => {
                    const linkData = doc.data();
                    const linkCard = `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <p class="text-sm text-gray-500 truncate">Original: ${linkData.original}</p>
                            <a href="${linkData.short}" target="_blank" class="text-lg font-semibold text-indigo-600 hover:underline break-all">${linkData.short}</a>
                            <p class="text-gray-700 mt-2">Clicks: <span class="font-bold">${linkData.clicks}</span></p>
                            <button class="copy-btn mt-4 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 w-full" data-link="${linkData.short}">Copy Link</button>
                        </div>
                    `;
                    linksContainer.innerHTML += linkCard;
                });

                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const linkToCopy = button.getAttribute('data-link');
                        // Use a fallback for clipboard API
                        const textArea = document.createElement("textarea");
                        textArea.value = linkToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.textContent = 'Copied!';
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                            button.textContent = 'Error!';
                        }
                        document.body.removeChild(textArea);
                        setTimeout(() => { button.textContent = 'Copy Link'; }, 2000);
                    });
                });
            });
        }

        // --- Profile Update ---
        const profileForm = document.getElementById('profile-form');
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const name = document.getElementById('profile-name').value;
            const newPassword = document.getElementById('profile-password').value;
            const profileMessage = document.getElementById('profile-message');
            
            profileMessage.textContent = 'Updating...';
            profileMessage.className = 'text-green-500 mt-4 text-center';

            try {
                if (name !== user.displayName) {
                    await updateProfile(user, { displayName: name });
                    const userDocRef = doc(db, "users", user.uid);
                    await updateDoc(userDocRef, { name: name });
                }

                if (newPassword) {
                    await updatePassword(user, newPassword);
                }

                profileMessage.textContent = 'Profile updated successfully!';
                document.getElementById('profile-password').value = '';
                setTimeout(() => { profileMessage.textContent = ''; }, 3000);

            } catch (error) {
                profileMessage.textContent = `Error: ${error.message}`;
                profileMessage.className = 'text-red-500 mt-4 text-center';
            }
        });
        
        // --- Phone Verification Logic ---
        function updatePhoneVerificationUI(userData) {
            const phoneInputGroup = document.getElementById('phone-input-group');
            const otpInputGroup = document.getElementById('otp-input-group');
            const verifiedStatus = document.getElementById('phone-verified-status');
            const phoneInput = document.getElementById('profile-phone');
            
            phoneInput.value = userData.phone || '';
            
            if (userData.phoneVerified) {
                phoneInputGroup.classList.add('hidden');
                otpInputGroup.classList.add('hidden');
                verifiedStatus.classList.remove('hidden');
            } else if (userData.phone && userData.phoneOtp) {
                phoneInputGroup.classList.add('hidden');
                otpInputGroup.classList.remove('hidden');
                verifiedStatus.classList.add('hidden');
            } else {
                phoneInputGroup.classList.remove('hidden');
                otpInputGroup.classList.add('hidden');
                verifiedStatus.classList.add('hidden');
            }
        }
        
        document.getElementById('save-phone-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const phone = document.getElementById('profile-phone').value;
            const messageEl = document.getElementById('phone-verification-message');
            
            if (!phone) {
                messageEl.textContent = 'Please enter a phone number.';
                messageEl.className = 'mt-4 text-center text-red-500';
                return;
            }
            
            const userDocRef = doc(db, "users", user.uid);
            // We only save the phone number. The OTP is generated by the admin.
            await updateDoc(userDocRef, { phone: phone, phoneVerified: false });
            messageEl.textContent = 'Phone number saved. Please wait for an admin to send an OTP.';
            messageEl.className = 'mt-4 text-center text-green-500';
            // Manually update UI state
            updatePhoneVerificationUI({ phone: phone, phoneVerified: false, phoneOtp: '' });
        });

        document.getElementById('verify-otp-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const otp = document.getElementById('profile-otp').value;
            const messageEl = document.getElementById('phone-verification-message');
            
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            const userData = userDoc.data();
            
            if (otp && otp === userData.phoneOtp) {
                await updateDoc(userDocRef, { phoneVerified: true, phoneOtp: '' }); // Clear OTP after verification
                messageEl.textContent = 'Phone verified successfully!';
                messageEl.className = 'mt-4 text-center text-green-500';
                updatePhoneVerificationUI({ ...userData, phoneVerified: true });
            } else {
                messageEl.textContent = 'Invalid OTP. Please try again.';
                messageEl.className = 'mt-4 text-center text-red-500';
            }
        });

        // --- Dashboard & Rewards ---
        function updateDashboard(clicks, claimedRewards) {
            document.getElementById('total-clicks').textContent = clicks;

            const tiers = {
                starter: { clicks: 5, color: 'green' },
                bronze: { clicks: 7500, color: 'yellow' },
                silver: { clicks: 15000, color: 'gray' },
                gold: { clicks: 50000, color: 'yellow' },
                diamond: { clicks: 100000, color: 'blue' }
            };

            for (const [tier, data] of Object.entries(tiers)) {
                const progress = Math.min((clicks / data.clicks) * 100, 100);
                const progressBar = document.getElementById(`${tier}-progress`);
                const claimButton = document.getElementById(`claim-${tier}`);

                progressBar.style.width = `${progress}%`;

                if (claimedRewards[tier]) {
                    claimButton.textContent = 'Claimed';
                    claimButton.disabled = true;
                    claimButton.className = 'claim-btn w-full bg-green-600 text-white py-2 rounded-lg';
                } else if (clicks >= data.clicks) {
                    claimButton.textContent = 'Claim Reward';
                    claimButton.disabled = false;
                    claimButton.className = `claim-btn w-full bg-${data.color}-500 hover:bg-${data.color}-600 text-white py-2 rounded-lg`;
                } else {
                    claimButton.textContent = 'Claim Reward';
                    claimButton.disabled = true;
                    claimButton.className = 'claim-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed';
                }
            }
        }

        document.querySelector('#dashboard-page').addEventListener('click', async (e) => {
            if (e.target.classList.contains('claim-btn')) {
                const user = auth.currentUser;
                if (!user || e.target.disabled) return;

                const tier = e.target.dataset.tier;
                const userDocRef = doc(db, "users", user.uid);
                
                try {
                    await updateDoc(userDocRef, {
                        [`claimedRewards.${tier}`]: true
                    });
                    showCustomModal("Success", `You have successfully claimed the ${tier} tier reward!`);
                } catch (error) {
                    console.error("Error claiming reward: ", error);
                    showCustomModal("Error", "Could not claim reward. Please try again.");
                }
            }
        });

        // --- Attendance ---
        async function checkUserAttendance(userId) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const attendanceDocRef = doc(db, `users/${userId}/attendance`, today);
            const attendanceDoc = await getDoc(attendanceDocRef);
            const statusEl = document.getElementById('attendance-status');
            const buttonEl = document.getElementById('mark-attendance-btn');

            if (attendanceDoc.exists()) {
                statusEl.textContent = `Attendance marked for today at ${attendanceDoc.data().timestamp.toDate().toLocaleTimeString()}`;
                statusEl.className = 'mt-4 text-center font-semibold text-green-600';
                buttonEl.disabled = true;
                buttonEl.textContent = 'Attendance Marked';
                buttonEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                buttonEl.classList.remove('bg-green-600', 'hover:bg-green-700');
            } else {
                statusEl.textContent = 'You have not marked your attendance for today.';
                statusEl.className = 'mt-4 text-center font-semibold text-red-600';
                buttonEl.disabled = false;
                buttonEl.textContent = 'Mark Attendance';
                buttonEl.classList.remove('bg-gray-400', 'cursor-not-allowed');
                buttonEl.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        document.getElementById('attendance-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const workLink = document.getElementById('attendance-link').value;
            const today = new Date().toISOString().split('T')[0];
            const attendanceDocRef = doc(db, `users/${user.uid}/attendance`, today);

            try {
                await setDoc(attendanceDocRef, {
                    link: workLink,
                    timestamp: Timestamp.now()
                });
                checkUserAttendance(user.uid); // Re-check to update UI
            } catch (error) {
                console.error("Error marking attendance: ", error);
                document.getElementById('attendance-status').textContent = 'Error: Could not mark attendance.';
                document.getElementById('attendance-status').className = 'mt-4 text-center font-semibold text-red-500';
            }
        });

        // --- Resume Management ---
        document.getElementById('add-resume-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            const resumeDocRef = doc(db, `users/${user.uid}/resume`, 'data');
            const resumeDoc = await getDoc(resumeDocRef);
            const resumeData = resumeDoc.exists() ? resumeDoc.data() : {};

            const modalContent = `
                <form id="resume-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="resume-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${resumeData.name || user.displayName || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="resume-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" value="${user.email}" readonly>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="resume-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${resumeData.phone || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Professional Summary</label>
                        <textarea id="resume-summary" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>${resumeData.summary || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Experience</label>
                        <textarea id="resume-experience" rows="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Company Name - Job Title (YYYY-MM to YYYY-MM)\n- Responsibility 1\n- Responsibility 2" required>${resumeData.experience || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Education</label>
                        <textarea id="resume-education" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="University Name - Degree (YYYY-MM to YYYY-MM)" required>${resumeData.education || ''}</textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Save Resume</button>
                    <div id="resume-form-status" class="text-center mt-2"></div>
                </form>
            `;
            showCustomModal('Create / Edit Your Resume', modalContent);

            document.getElementById('resume-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('resume-form-status');
                statusEl.textContent = 'Saving...';
                const updatedResumeData = {
                    name: document.getElementById('resume-name').value,
                    email: document.getElementById('resume-email').value,
                    phone: document.getElementById('resume-phone').value,
                    summary: document.getElementById('resume-summary').value,
                    experience: document.getElementById('resume-experience').value,
                    education: document.getElementById('resume-education').value,
                    updatedAt: Timestamp.now()
                };
                
                try {
                    await setDoc(resumeDocRef, updatedResumeData);
                    statusEl.textContent = 'Resume saved successfully!';
                    statusEl.className = 'text-center mt-2 text-green-600';
                    document.getElementById('resume-status').textContent = 'You have a saved resume on file.';
                    setTimeout(() => document.getElementById('modals-container').innerHTML = '', 2000);
                } catch (error) {
                    console.error("Error saving resume: ", error);
                    statusEl.textContent = 'Error saving resume.';
                    statusEl.className = 'text-center mt-2 text-red-600';
                }
            });
        });


        // --- Admin Panel Logic ---
        document.getElementById('admin-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('admin-login', true);
            document.querySelector('nav').classList.add('hidden');
            document.querySelector('footer').classList.add('hidden');
        });

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');

            if (email === 'admin@system.com' && password === '123') {
                errorEl.textContent = '';
                showPage('admin-dashboard', true);
                setupAdminDashboard();
            } else {
                errorEl.textContent = 'Invalid admin credentials.';
            }
        });

        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            document.querySelector('nav').classList.remove('hidden');
            document.querySelector('footer').classList.remove('hidden');
            window.location.reload();
        });
        
        function setupAdminDashboard() {
            const adminCardBtns = document.querySelectorAll('.admin-card-btn');
            const adminViews = document.querySelectorAll('.admin-view');
            
            adminCardBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    adminViews.forEach(view => view.classList.toggle('hidden', view.id !== targetId));
                    
                    // Load data for the selected view
                    if (targetId === 'admin-view-users') loadAllUsers();
                    if (targetId === 'admin-view-attendance') loadAdminAttendance();
                    if (targetId === 'admin-view-cvs') loadAdminCVs();
                    if (targetId === 'admin-view-links') loadGlobalLinks();
                });
            });
            
            // Initially load the first view
            loadAllUsers();
        }
        
        async function loadAllUsers() {
             const userListBody = document.getElementById('admin-all-users-list');
            userListBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
            const usersCollectionRef = collection(db, "users");
            const userSnapshot = await getDocs(usersCollectionRef);
            let users = userSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            
            function renderUsers(userArray) {
                userListBody.innerHTML = '';
                if (userArray.length === 0) {
                    userListBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No users found.</td></tr>';
                    return;
                }
                userArray.forEach(user => {
                    const phoneStatus = user.phoneVerified 
                        ? `<span class="text-green-600 font-semibold">Verified</span>` 
                        : (user.phone ? `<span class="text-yellow-600 font-semibold">Pending</span>` : `<span>Not Added</span>`);
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="p-4"><div class="font-semibold">${user.name}</div><div class="text-sm text-gray-500">${user.email}</div></td>
                        <td class="p-4">${user.phone || 'N/A'} (${phoneStatus})</td>
                        <td class="p-4 font-bold">${user.clicks}</td>
                        <td class="p-4"><button data-userid="${user.id}" class="details-btn bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600">Details</button></td>
                    `;
                    userListBody.appendChild(row);
                });
            }
            
            renderUsers(users);
            
            document.getElementById('admin-user-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredUsers = users.filter(u => u.name.toLowerCase().includes(searchTerm) || u.email.toLowerCase().includes(searchTerm));
                renderUsers(filteredUsers);
            });

            userListBody.addEventListener('click', e => {
                if (e.target.classList.contains('details-btn')) {
                    const userId = e.target.dataset.userid;
                    const userData = users.find(u => u.id === userId);
                    openUserDetailsModal(userData);
                }
            });
        }
        
        async function openUserDetailsModal(user) {
            const modalsContainer = document.getElementById('modals-container');
            
            const phoneStatus = user.phoneVerified ? 'Verified' : (user.phone ? 'Pending' : 'Not Added');
            const phoneAction = !user.phoneVerified && user.phone 
                ? `<button id="generate-otp-btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Generate & Send OTP</button>`
                : '';

            const modalHTML = `
                <div id="user-details-modal" class="modal-backdrop">
                    <div class="modal-content bg-white rounded-lg shadow-lg w-11/12 md:w-1/2 lg:w-1/3">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-2xl font-bold">${user.name}</h2>
                            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Phone:</strong> ${user.phone || 'N/A'} (<span class="font-semibold">${phoneStatus}</span>)</p>
                            <div id="otp-display" class="my-2"></div>
                            <div>${phoneAction}</div>
                            <hr>
                            <h3 class="font-bold">Send Direct Message</h3>
                            <textarea id="direct-message-text" class="w-full p-2 border rounded" rows="3" placeholder="Type your message..."></textarea>
                            <button id="send-direct-message-btn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Send Message</button>
                            <div id="direct-message-status" class="text-sm mt-2"></div>
                        </div>
                    </div>
                </div>
            `;
            modalsContainer.innerHTML = modalHTML;
            
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modalsContainer.innerHTML = '';
            });

            if (document.getElementById('generate-otp-btn')) {
                document.getElementById('generate-otp-btn').addEventListener('click', async () => {
                    const otp = Math.floor(1000 + Math.random() * 9000).toString();
                    const userDocRef = doc(db, "users", user.id);
                    await updateDoc(userDocRef, { phoneOtp: otp });
                    document.getElementById('otp-display').innerHTML = `<p class="text-green-600">OTP Generated: <strong class="text-lg">${otp}</strong>. Please provide this to the user.</p>`;
                    document.getElementById('generate-otp-btn').style.display = 'none';
                });
            }
            
            document.getElementById('send-direct-message-btn').addEventListener('click', async () => {
                const message = document.getElementById('direct-message-text').value;
                if (!message) return;
                
                // This is a direct message, but we'll add it to the broadcast collection for simplicity
                // In a real app, this would be a separate collection
                const notificationRef = collection(db, "broadcast_notifications");
                await addDoc(notificationRef, {
                    message: `Message for ${user.name}: ${message}`,
                    timestamp: Timestamp.now(),
                });
                
                document.getElementById('direct-message-status').textContent = 'Message sent as a notification!';
                document.getElementById('direct-message-text').value = '';
                setTimeout(() => { document.getElementById('direct-message-status').textContent = ''; }, 3000);
            });
        }
        
        // --- Admin: Attendance View ---
        async function loadAdminAttendance() {
            const listBody = document.getElementById('admin-attendance-list');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('today-date').textContent = new Date().toLocaleDateString();
            listBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Loading...</td></tr>';

            const usersCollectionRef = collection(db, "users");
            const userSnapshot = await getDocs(usersCollectionRef);
            let attendanceData = [];

            for (const userDoc of userSnapshot.docs) {
                const user = { id: userDoc.id, ...userDoc.data() };
                const attendanceDocRef = doc(db, `users/${user.id}/attendance`, today);
                const attendanceDoc = await getDoc(attendanceDocRef);
                
                attendanceData.push({
                    name: user.name,
                    email: user.email,
                    present: attendanceDoc.exists(),
                    link: attendanceDoc.exists() ? attendanceDoc.data().link : 'N/A'
                });
            }

            listBody.innerHTML = '';
            if (attendanceData.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">No users found.</td></tr>';
                 return;
            }

            attendanceData.forEach(item => {
                const status = item.present ? '<span class="text-green-600 font-bold">Present</span>' : '<span class="text-red-600">Absent</span>';
                const link = item.present ? `<a href="${item.link}" target="_blank" class="text-indigo-600 hover:underline">${item.link}</a>` : 'N/A';
                const row = `
                    <tr class="border-b">
                        <td class="p-4"><div class="font-semibold">${item.name}</div><div class="text-sm text-gray-500">${item.email}</div></td>
                        <td class="p-4">${status}</td>
                        <td class="p-4 truncate" style="max-width: 300px;">${link}</td>
                    </tr>
                `;
                listBody.innerHTML += row;
            });
        }

        // --- Admin: CVs View ---
        async function loadAdminCVs() {
            const listBody = document.getElementById('admin-cv-list');
            listBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Loading...</td></tr>';
            
            const usersCollectionRef = collection(db, "users");
            const userSnapshot = await getDocs(usersCollectionRef);
            let cvData = [];

            for (const userDoc of userSnapshot.docs) {
                const user = { id: userDoc.id, ...userDoc.data() };
                const resumeDocRef = doc(db, `users/${user.id}/resume`, 'data');
                const resumeDoc = await getDoc(resumeDocRef);
                if (resumeDoc.exists()) {
                    cvData.push({ ...user, resume: resumeDoc.data() });
                }
            }

            listBody.innerHTML = '';
            if (cvData.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">No resumes submitted yet.</td></tr>';
                 return;
            }

            cvData.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-4 font-semibold">${user.name}</td>
                    <td class="p-4">${user.email}</td>
                    <td class="p-4"><button data-userid="${user.id}" class="view-cv-btn bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">View Resume</button></td>
                `;
                listBody.appendChild(row);
            });

            listBody.addEventListener('click', e => {
                if (e.target.classList.contains('view-cv-btn')) {
                    const userId = e.target.dataset.userid;
                    const userData = cvData.find(u => u.id === userId);
                    generateAndShowPDF(userData.resume);
                }
            });
        }

        function generateAndShowPDF(resumeData) {
            const doc = new jsPDF();
            let y = 20;

            doc.setFontSize(22);
            doc.text(resumeData.name, 105, y, { align: 'center' });
            y += 8;
            doc.setFontSize(12);
            doc.text(`${resumeData.email} | ${resumeData.phone}`, 105, y, { align: 'center' });
            y += 15;

            doc.setFontSize(16);
            doc.text('Professional Summary', 20, y);
            y += 7;
            doc.setFontSize(11);
            doc.text(doc.splitTextToSize(resumeData.summary, 170), 20, y);
            y += (doc.getTextDimensions(doc.splitTextToSize(resumeData.summary, 170)).h) + 10;

            doc.setFontSize(16);
            doc.text('Experience', 20, y);
            y += 7;
            doc.setFontSize(11);
            doc.text(doc.splitTextToSize(resumeData.experience, 170), 20, y);
            y += (doc.getTextDimensions(doc.splitTextToSize(resumeData.experience, 170)).h) + 10;

            doc.setFontSize(16);
            doc.text('Education', 20, y);
            y += 7;
            doc.setFontSize(11);
            doc.text(doc.splitTextToSize(resumeData.education, 170), 20, y);

            doc.output('dataurlnewwindow');
        }

        // --- Admin: Links View ---
        async function loadGlobalLinks() {
            const linksList = document.getElementById('global-links-list');
            const q = query(collection(db, "global_links"));
            onSnapshot(q, (snapshot) => {
                linksList.innerHTML = '';
                if (snapshot.empty) {
                    linksList.innerHTML = '<p>No global links exist.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const linkData = doc.data();
                    const linkId = doc.id;
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    el.innerHTML = `
                        <span class="truncate">${linkData.original}</span>
                        <button data-linkid="${linkId}" class="delete-link-btn bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">Delete</button>
                    `;
                    linksList.appendChild(el);
                });
            });
        }

        document.getElementById('global-links-list').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-link-btn')) {
                const linkId = e.target.dataset.linkid;
                if (confirm('Are you sure you want to delete this link for ALL users? This cannot be undone.')) {
                    // This is a complex operation. For this example, we'll just delete the global link.
                    // A full implementation would need a Cloud Function to delete subcollections.
                    await deleteDoc(doc(db, "global_links", linkId));
                    alert('Global link deleted. Note: Individual user links need manual cleanup or a Cloud Function.');
                }
            }
        });

        document.getElementById('add-link-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('add-link-status');
            const url = document.getElementById('new-link-url').value;
            statusEl.textContent = 'Adding link...';

            try {
                // 1. Add to global_links
                const globalLinkRef = await addDoc(collection(db, "global_links"), { original: url });
                const linkId = globalLinkRef.id;

                // 2. Add to every existing user
                const usersQuery = query(collection(db, "users"));
                const usersSnapshot = await getDocs(usersQuery);

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const shortCode = generateShortCode(url, userId, linkId);
                    const shortUrl = getShortUrl(shortCode);

                    const userLinkDocRef = doc(db, `users/${userId}/links`, linkId);
                    await setDoc(userLinkDocRef, { original: url, short: shortUrl, clicks: 0, global: true });

                    const shortLinkDocRef = doc(db, "shortlinks", shortCode);
                    await setDoc(shortLinkDocRef, { original: url, ownerId: userId, linkId: linkId });
                }

                statusEl.textContent = 'Link added successfully for all users!';
                statusEl.className = 'mt-2 text-center text-green-600';
                document.getElementById('add-link-form').reset();
            } catch (error) {
                console.error("Error adding global link:", error);
                statusEl.textContent = 'Error adding link.';
                statusEl.className = 'mt-2 text-center text-red-500';
            }
        });

        // --- Admin: Notification View ---
        document.getElementById('notification-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('notification-message').value;
            const statusEl = document.getElementById('notification-send-status');
            statusEl.textContent = 'Sending...';

            try {
                await addDoc(collection(db, "broadcast_notifications"), {
                    message: message,
                    timestamp: Timestamp.now()
                });
                statusEl.textContent = 'Notification sent successfully!';
                document.getElementById('notification-form').reset();
                setTimeout(() => statusEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error sending notification:", error);
                statusEl.textContent = 'Error sending notification.';
                statusEl.className = 'text-red-500 mt-4 text-center font-semibold';
            }
        });
        
        // --- User Notification System ---
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationList = document.getElementById('notification-list');
        const notificationDot = document.getElementById('notification-dot');

        document.getElementById('notification-bell').addEventListener('click', () => {
            notificationDropdown.classList.toggle('hidden');
            if (!notificationDropdown.classList.contains('hidden')) {
                notificationDot.classList.add('hidden');
                // Mark all visible notifications as seen
                const user = auth.currentUser;
                if (!user) return;
                const unseenNotifs = Array.from(notificationList.children)
                    .filter(el => el.dataset.seen === 'false')
                    .map(el => el.dataset.notifid);
                
                if (unseenNotifs.length > 0) {
                    const userDocRef = doc(db, "users", user.uid);
                    getDoc(userDocRef).then(docSnap => {
                        const currentSeen = docSnap.data().seenNotifications || [];
                        updateDoc(userDocRef, { seenNotifications: [...new Set([...currentSeen, ...unseenNotifs])] });
                    });
                }
            }
        });

        function listenForNotifications(userId) {
            const userDocRef = doc(db, "users", userId);
            
            const q = query(collection(db, "broadcast_notifications"), orderBy("timestamp", "desc"), limit(10));
            
            const unsubscribe = onSnapshot(q, async (snapshot) => {
                const userDoc = await getDoc(userDocRef);
                const seenNotifications = userDoc.data().seenNotifications || [];
                let hasUnseen = false;
                
                notificationList.innerHTML = '';
                if (snapshot.empty) {
                    notificationList.innerHTML = '<p class="p-4 text-gray-500 text-sm">No notifications yet.</p>';
                    return;
                }

                snapshot.forEach(notifDoc => {
                    const notifData = notifDoc.data();
                    const notifId = notifDoc.id;
                    const isSeen = seenNotifications.includes(notifId);
                    if (!isSeen) hasUnseen = true;

                    const notifElement = document.createElement('div');
                    notifElement.dataset.notifid = notifId;
                    notifElement.dataset.seen = isSeen;
                    notifElement.className = `p-4 border-b hover:bg-gray-100 ${isSeen ? 'text-gray-500' : 'font-bold text-gray-800'}`;
                    notifElement.innerHTML = `
                        <p class="text-sm">${notifData.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${notifData.timestamp.toDate().toLocaleString()}</p>
                    `;
                    notificationList.appendChild(notifElement);
                });
                
                notificationDot.classList.toggle('hidden', !hasUnseen);
            });
            return unsubscribe;
        }

    </script>
</body>
</html>
